const Ht="modulepreload",jt=function(t){return"/"+t},vt={},wt=function(e,r,o){let i=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),s=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));i=Promise.allSettled(r.map(a=>{if(a=jt(a),a in vt)return;vt[a]=!0;const c=a.endsWith(".css"),g=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${g}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":Ht,c||(m.as="script"),m.crossOrigin="",m.href=a,s&&m.setAttribute("nonce",s),document.head.appendChild(m),c)return new Promise((f,h)=>{m.addEventListener("load",f),m.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${a}`)))})}))}function l(d){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=d,window.dispatchEvent(s),!s.defaultPrevented)throw d}return i.then(d=>{for(const s of d||[])s.status==="rejected"&&l(s.reason);return e().catch(l)})},u={};function _t(){Object.assign(u,{layoutModeBtn:document.getElementById("layout-mode-btn"),stitchingModeBtn:document.getElementById("stitching-mode-btn"),layoutControls:document.getElementById("layout-controls"),layoutContainer:document.getElementById("layout-container"),stitchingControls:document.getElementById("stitching-controls"),stitchingDirectionBtns:document.getElementById("stitching-direction-btns"),stitchingUploadBtn:document.getElementById("stitching-upload-btn"),stitchingUploadInput:document.getElementById("stitching-upload-input"),layoutWrapper:document.getElementById("layout-wrapper"),layoutGrid:document.getElementById("layout-grid"),stitchingWrapper:document.getElementById("stitching-wrapper"),stitchingGrid:document.getElementById("stitching-grid"),canvasHint:document.getElementById("canvas-hint"),canvasSettings:document.getElementById("canvas-settings"),aspectRatioBtns:document.getElementById("aspect-ratio-btns"),spacingSlider:document.getElementById("spacing-slider"),spacingValue:document.getElementById("spacing-value"),radiusSlider:document.getElementById("radius-slider"),radiusValue:document.getElementById("radius-value"),colorPicker:document.getElementById("color-picker"),shuffleBtn:document.getElementById("shuffle-btn"),downloadBtn:document.getElementById("download-btn"),borderTopInput:document.getElementById("border-top-input"),borderRightInput:document.getElementById("border-right-input"),borderBottomInput:document.getElementById("border-bottom-input"),borderLeftInput:document.getElementById("border-left-input"),borderControls:document.getElementById("border-controls"),toast:document.getElementById("toast")})}function x(t,e){const r=document.createElement(t);return e&&(r.className=e),r}const j={upload:'<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',remove:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',replace:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',zoomIn:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',zoomOut:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>',zoomReset:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="4"></circle></svg>',pan:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l0 20"/><path d="M2 12l20 0"/><path d="m5 15 3-3-3-3"/><path d="m19 9-3 3 3 3"/></svg>',reset:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14m-7-7h14" stroke="#000" stroke-width="2"/><path d="M18.5 9L12 15.5 5.5 9" stroke="#000" stroke-width="2"/></svg>'},D={"2-t1b1":{g:2,gr:[2,1],c:[{r:1,c:1},{r:1,c:1}]},"2-l1r1":{g:2,gr:[1,2],c:[{r:1,c:1},{r:1,c:1}]},"3-t1b2":{g:3,gr:[2,2],c:[{r:1,c:2},{r:1,c:1},{r:1,c:1}]},"3-t2b1":{g:3,gr:[2,2],c:[{r:1,c:1},{r:1,c:1},{r:1,c:2}]},"3-l1r2":{g:3,gr:[2,2],c:[{r:2,c:1},{r:1,c:1},{r:1,c:1}]},"3-l2r1":{g:3,gr:[2,2],c:[{r:1,c:1},{r:2,c:1},{r:1,c:1}]},"3-l1rr":{g:3,gr:[3,3],c:[{r:3,c:2},{r:1,c:1},{r:2,c:1}]},"3-t1bb":{g:3,gr:[3,3],c:[{r:2,c:3},{r:1,c:1},{r:1,c:2}]},"4-grid":{g:4,gr:[2,2]},"4-t1b3":{g:4,gr:[2,3],c:[{r:1,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"4-b1t3":{g:4,gr:[2,3],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:3}]},"4-l1r3":{g:4,gr:[3,2],c:[{r:3,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"4-l-feat":{g:4,gr:[2,3],c:[{r:2,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1}]},"4-r-feat":{g:4,gr:[2,3],c:[{r:1,c:2},{r:2,c:1},{r:1,c:1},{r:1,c:1,s:[2,1]}]},"4-121":{g:4,gr:[3,2],c:[{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:2}]},"4-212":{g:4,gr:[2,3],c:[{r:2,c:1},{r:1,c:1},{r:2,c:1},{r:1,c:1}]},"4-g3x2-alt":{g:4,gr:[3,2],c:[{r:2,c:1},{r:1,c:1,s:[3,1]},{r:1,c:1,s:[1,2]},{r:2,c:1,s:[2,2]}]},"5-center":{g:5,gr:[3,3],c:[{r:1,c:2},{r:2,c:1},{r:2,c:1},{r:1,c:1},{r:1,c:2}]},"5-l3r2":{g:5,gr:[3,3],c:[{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:2,c:2},{r:1,c:1}]},"5-131":{g:5,gr:[3,3],c:[{r:3,c:1},{r:1,c:1},{r:3,c:1},{r:1,c:1},{r:1,c:1}]},"5-l2r3":{g:5,gr:[3,2],c:[{r:2,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"5-t2b3":{g:5,gr:[2,3],c:[{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"5-center-h-bar":{g:5,gr:[3,2],c:[{r:1,c:1},{r:1,c:1,s:[1,2]},{r:1,c:2,s:[2,1]},{r:1,c:1,s:[3,1]},{r:1,c:1,s:[3,2]}]},"5-t2b3-split":{g:5,gr:[2,6],c:[{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2}]},"5-l1r4-col":{g:5,gr:[4,2],c:[{r:4,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"5-t-feat-r":{g:5,gr:[2,3],c:[{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"5-t1b4-grid":{g:5,gr:[3,2],c:[{r:1,c:2},{r:1,c:1,s:[2,1]},{r:1,c:1,s:[2,2]},{r:1,c:1,s:[3,1]},{r:1,c:1,s:[3,2]}]},"5-r1l4-col":{g:5,gr:[4,2],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:4,c:1,s:[1,2]}]},"5-cross-center":{g:5,gr:[3,3],c:[{r:1,c:3},{r:1,c:1,s:[2,1]},{r:1,c:1,s:[2,2]},{r:1,c:1,s:[2,3]},{r:1,c:3,s:[3,1]},{r:1,c:1,s:[2,2]}]},"5-l-tall-r-split":{g:5,gr:[3,3],c:[{r:3,c:1},{r:1,c:2},{r:1,c:1,s:[2,2]},{r:1,c:1,s:[2,3]},{r:1,c:2,s:[3,2]}]},"5-213":{g:5,gr:[2,3],c:[{r:1,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"5-123":{g:5,gr:[2,3],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:3}]},"6-g3x2":{g:6,gr:[3,2]},"6-g2x3":{g:6,gr:[2,3]},"6-center":{g:6,gr:[4,4],c:[{r:1,c:3},{r:2,c:1},{r:3,c:1},{r:2,c:2},{r:2,c:1},{r:1,c:2}]},"6-123":{g:6,gr:[3,6],c:[{r:1,c:6},{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2}]},"6-321":{g:6,gr:[3,6],c:[{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:3},{r:1,c:3},{r:1,c:6}]},"6-231":{g:6,gr:[3,6],c:[{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:6}]},"6-222":{g:6,gr:[3,3],c:[{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:2},{r:1,c:1}]},"6-1133":{g:6,gr:[4,3],c:[{r:2,c:3},{r:1,c:1},{r:1,c:1},{r:2,c:1},{r:1,c:1},{r:1,c:1}]},"6-223r":{g:6,gr:[3,3],c:[{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"6-223l":{g:6,gr:[3,3],c:[{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"6-114":{g:6,gr:[3,5],c:[{r:2,c:5},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"6-3333":{g:6,gr:[4,4],c:[{r:2,c:2},{r:2,c:1},{r:2,c:1},{r:2,c:1},{r:2,c:1},{r:2,c:2}]},"7-main":{g:7,gr:[4,4],c:[{r:2,c:2},{r:2,c:2},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-h-center-band":{g:7,gr:[3,3],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-w-center-band":{g:7,gr:[3,3],c:[{r:1,c:1},{r:3,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-feat-l":{g:7,gr:[4,2],c:[{r:2,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-feat-t":{g:7,gr:[4,2],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:1},{r:1,c:1}]},"7-311":{g:7,gr:[3,3],c:[{r:1,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-113":{g:7,gr:[3,3],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:3}]},"7-232":{g:7,gr:[3,6],c:[{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:3},{r:1,c:3}]},"7-124":{g:7,gr:[3,4],c:[{r:2,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-323":{g:7,gr:[3,4],c:[{r:1,c:1},{r:2,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-313":{g:7,gr:[4,3],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:3,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"7-331":{g:7,gr:[3,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:3},{r:1,c:1},{r:1,c:1}]},"7-233":{g:7,gr:[4,6],c:[{r:2,c:3},{r:2,c:3},{r:1,c:2},{r:2,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2}]},"7-333":{g:7,gr:[3,3],c:[{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2}]},"7-346":{g:7,gr:[4,6],c:[{r:1,c:2},{r:2,c:2},{r:2,c:2},{r:1,c:2},{r:2,c:3},{r:1,c:3},{r:1,c:3}]},"8-g4x2":{g:8,gr:[4,2]},"8-g2x4":{g:8,gr:[2,4]},"8-222":{g:8,gr:[4,4],c:[{r:1,c:2},{r:2,c:1},{r:2,c:1},{r:1,c:2},{r:2,c:1},{r:2,c:1},{r:1,c:2},{r:1,c:2}]},"8-l2-tall-r6-grid":{g:8,gr:[3,4],c:[{r:3,c:1},{r:1,c:1},{r:1,c:1},{r:3,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"8-sandwich-6":{g:8,gr:[4,3],c:[{r:1,c:3},{r:1,c:1,s:[2,1]},{r:1,c:1,s:[2,2]},{r:1,c:1,s:[2,3]},{r:1,c:1,s:[3,1]},{r:1,c:1,s:[3,2]},{r:1,c:1,s:[3,3]},{r:1,c:3,s:[4,1]}]},"8-313":{g:8,gr:[5,4],c:[{r:2,c:2},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:2,c:2}]},"8-131":{g:8,gr:[4,5],c:[{r:2,c:2},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:2,c:2},{r:1,c:1}]},"8-134":{g:8,gr:[4,4],c:[{r:3,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"8-431":{g:8,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:3,c:3},{r:1,c:1},{r:1,c:1}]},"8-323":{g:8,gr:[3,6],c:[{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2}]},"8-363":{g:8,gr:[6,3],c:[{r:2,c:1},{r:3,c:1},{r:2,c:1},{r:2,c:1},{r:2,c:1},{r:3,c:1},{r:2,c:1},{r:2,c:1}]},"8-344":{g:8,gr:[4,4],c:[{r:1,c:1},{r:2,c:1},{r:2,c:2},{r:1,c:1},{r:2,c:2},{r:2,c:1},{r:1,c:1},{r:1,c:1}]},"9-grid":{g:9,gr:[3,3]},"9-144-grid":{g:9,gr:[3,4],c:[{r:1,c:4},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-414-grid":{g:9,gr:[3,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:4},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-441-grid":{g:9,gr:[3,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:4}]},"9-211-grid":{g:9,gr:[3,4],c:[{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-112-grid":{g:9,gr:[3,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1}]},"9-434-grid":{g:9,gr:[4,4],c:[{r:1,c:1},{r:4,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-344-grid":{g:9,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:4},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-424-grid":{g:9,gr:[4,4],c:[{r:2,c:2},{r:2,c:1},{r:2,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1}]},"9-116-grid":{g:9,gr:[6,6],c:[{r:3,c:3},{r:3,c:3},{r:3,c:3},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"9-611-grid":{g:9,gr:[6,6],c:[{r:2,c:2},{r:1,c:1},{r:3,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:3,c:3},{r:3,c:3}]},"9-cen-grid":{g:9,gr:[4,4],c:[{r:1,c:2},{r:1,c:2},{r:2,c:1},{r:2,c:2},{r:2,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-g5x2":{g:10,gr:[5,2]},"10-t2b8-grid":{g:10,gr:[3,4],c:[{r:1,c:2},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-424-grid":{g:10,gr:[3,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-4x3-grid":{g:10,gr:[4,3],c:[{r:1,c:3},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-5x5-grid":{g:10,gr:[5,5],c:[{r:4,c:4},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-4x4-grid":{g:10,gr:[4,4],c:[{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1}]},"10-8x8-grid":{g:10,gr:[8,8],c:[{r:4,c:4},{r:4,c:4},{r:4,c:4},{r:2,c:2},{r:2,c:2},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-442-grid":{g:10,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"10-6x6-grid":{g:10,gr:[6,6],c:[{r:2,c:2},{r:2,c:2},{r:2,c:2},{r:2,c:2},{r:1,c:2},{r:2,c:2},{r:1,c:2},{r:2,c:2},{r:2,c:2},{r:2,c:2}]},"11-4c4-t":{g:11,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:1},{r:2,c:2},{r:2,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"11-4x4-t":{g:11,gr:[4,4],c:[{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:1}]},"11-4x6-t":{g:11,gr:[4,6],c:[{r:1,c:3},{r:1,c:3},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2},{r:1,c:2}]},"11-feat-t":{g:11,gr:[3,5],c:[{r:1,c:5},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"11-feat-c":{g:11,gr:[3,5],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:5},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"11-feat-f":{g:11,gr:[3,5],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:5}]},"12-g4x3":{g:12,gr:[4,3]},"12-g3x4":{g:12,gr:[3,4]},"12-g6x6":{g:12,gr:[6,6],c:[{r:5,c:5},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"13-feat-c":{g:13,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"13-211":{g:13,gr:[4,4],c:[{r:2,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"13-112":{g:13,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:2},{r:1,c:1},{r:1,c:1}]},"14-g7x2":{g:14,gr:[7,2]},"14-g4x4r":{g:14,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"14-g4x4c":{g:14,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:2,c:1},{r:2,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"15-g5x3":{g:15,gr:[5,3]},"15-g4x4c":{g:15,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1}]},"15-g4x4f":{g:15,gr:[4,4],c:[{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:1},{r:1,c:2}]},"16-g4x4":{g:16,gr:[4,4]}},n={currentMode:"layout",shared:{spacing:10,radius:8,bgColor:"#FFFFFF",backgroundImage:null,borderWidths:{top:10,right:10,bottom:10,left:10},downloadQuality:"high-jpg",watermark:{enabled:!1,text:"ops-coffee.cn",fontSize:20,opacity:.25,rotation:45,density:"medium"},selectedTextId:null,selectedArrowId:null,selectedRectangleId:null,selectedEllipseId:null},layout:{currentLayoutId:"2-t1b1",layoutDef:D["2-t1b1"],aspectRatio:"1/1",imagesData:{},activeCellId:null,texts:[],arrows:[],rectangles:[],ellipses:[],colFractions:[],rowFractions:[]},stitching:{direction:"horizontal",images:[],texts:[],arrows:[],rectangles:[],ellipses:[]}};function Et(t){n.layout.currentLayoutId=t,n.layout.layoutDef=D[t]}function Yt(t,e){if(t){if(t.shared){const r=t.shared.watermark,{watermark:o,...i}=t.shared;Object.assign(n.shared,i),r&&Object.assign(n.shared.watermark,r)}e==="layout"&&t.layout?(Object.assign(n.layout,t.layout),n.layout.currentLayoutId&&Et(n.layout.currentLayoutId)):e==="stitching"&&t.stitching&&Object.assign(n.stitching,t.stitching),console.log(`Config loaded and applied for ${e} mode.`)}}const Lt="collageToolAppState",xt="collageToolConfig_layout",kt="collageToolConfig_stitching";function Nt(t){try{localStorage.setItem(Lt,JSON.stringify(t))}catch(e){console.error("Failed to save app state:",e)}}function Xt(){try{const t=localStorage.getItem(Lt);return t?JSON.parse(t):null}catch(t){return console.error("Failed to load or parse app state:",t),null}}function Gt(t,e){try{const r=t==="layout"?xt:kt,o=JSON.stringify(e);localStorage.setItem(r,o)}catch(r){console.error(`Failed to save config for mode "${t}":`,r)}}function Ut(t){try{const e=t==="layout"?xt:kt,r=localStorage.getItem(e);return r?JSON.parse(r):null}catch(e){return console.error(`Failed to load or parse config for mode "${t}":`,e),null}}function ht(){const t=u.layoutGrid;t.querySelectorAll(".gutter").forEach(d=>d.remove());const[e,r]=n.layout.layoutDef.gr,o=t.getBoundingClientRect(),i=n.layout.rowFractions.reduce((d,s)=>d+s,0),l=n.layout.colFractions.reduce((d,s)=>d+s,0);if(r>1){const d=n.layout.colFractions.map(a=>a/l*o.width);let s=0;for(let a=0;a<r-1;a++){s+=d[a];const c=x("div","gutter gutter-v");c.style.left=`${s}px`,c.style.height="100%",c.dataset.index=a,t.appendChild(c),bt(c,"v")}}if(e>1){const d=n.layout.rowFractions.map(a=>a/i*o.height);let s=0;for(let a=0;a<e-1;a++){s+=d[a];const c=x("div","gutter gutter-h");c.style.top=`${s}px`,c.style.width="100%",c.dataset.index=a,t.appendChild(c),bt(c,"h")}}}function bt(t,e){t.onmousedown=function(r){r.preventDefault();const o=u.layoutGrid,i=parseInt(t.dataset.index),l=o.getBoundingClientRect(),d=function(a){if(e==="v"){const c=n.layout.colFractions[i]+n.layout.colFractions[i+1],g=n.layout.colFractions.slice(0,i).reduce((p,v)=>p+v/n.layout.colFractions.reduce((S,B)=>S+B,0)*l.width,0);let f=(a.clientX-l.left-g)/l.width*n.layout.colFractions.reduce((p,v)=>p+v,0);f<.1&&(f=.1);let h=c-f;h<.1&&(h=.1,f=c-.1),n.layout.colFractions[i]=f,n.layout.colFractions[i+1]=h,o.style.gridTemplateColumns=n.layout.colFractions.map(p=>`${p}fr`).join(" ")}else{const c=n.layout.rowFractions[i]+n.layout.rowFractions[i+1],g=n.layout.rowFractions.slice(0,i).reduce((p,v)=>p+v/n.layout.rowFractions.reduce((S,B)=>S+B,0)*l.height,0);let f=(a.clientY-l.top-g)/l.height*n.layout.rowFractions.reduce((p,v)=>p+v,0);f<.1&&(f=.1);let h=c-f;h<.1&&(h=.1,f=c-.1),n.layout.rowFractions[i]=f,n.layout.rowFractions[i+1]=h,o.style.gridTemplateRows=n.layout.rowFractions.map(p=>`${p}fr`).join(" ")}},s=function(){document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s),setTimeout(ht,50)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)}}const Vt=Object.freeze(Object.defineProperty({__proto__:null,createGutters:ht},Symbol.toStringTag,{value:"Module"}));function lt(){return n.currentMode==="layout"?n.layout:n.stitching}const V={start(t,e){t.preventDefault(),t.stopPropagation();const r=t.type.startsWith("touch"),o=r?t.touches[0]:t,i={startX:o.clientX,startY:o.clientY,initialState:e.getInitialState?e.getInitialState():{}};e.onStart&&e.onStart(i);const l=s=>{s.preventDefault();const a=s.type.startsWith("touch")?s.touches[0]:s;e.onMove&&e.onMove(a,i)},d=()=>{document.removeEventListener(r?"touchmove":"mousemove",l),document.removeEventListener(r?"touchend":"mouseup",d),e.onEnd&&e.onEnd()};document.addEventListener(r?"touchmove":"mousemove",l,{passive:!1}),document.addEventListener(r?"touchend":"mouseup",d)}};function pt(t,e){if(!e)return;const r=x("div","text-element-container");r.id=`text-container-${t.id}`,Object.assign(r.style,{top:`${t.top}%`,left:`${t.left}%`,transform:"translate(-50%, -50%)"});const o=x("div","text-content");o.innerText=t.content,o.contentEditable="true",Object.assign(o.style,{color:t.color,fontSize:`${t.fontSize}px`,whiteSpace:"nowrap"});const i=x("div","text-toolbar");i.innerHTML=`<input type="number" value="${t.fontSize}" data-property="fontSize" title="Font Size"><input type="color" value="${t.color}" data-property="color" title="Font Color">`;const l=x("button","delete-text-button");l.innerHTML="&times;",l.title="Delete Text",r.append(i,o,l),e.appendChild(r),r.addEventListener("click",g=>{g.stopPropagation(),z(t.id)});const d=g=>g.stopPropagation();i.addEventListener("mousedown",d),i.addEventListener("touchstart",d);const s=g=>{const m=g.target.dataset.property;m&&dt({[m]:g.target.value})};i.addEventListener("input",s),i.addEventListener("change",s),o.addEventListener("blur",()=>dt({content:o.innerText}));const a=g=>{g.stopPropagation(),g.preventDefault(),Wt()};l.addEventListener("click",a),l.addEventListener("touchend",a);const c=g=>{g.target.closest(".text-toolbar")||g.target.closest(".delete-text-button")||(z(t.id),V.start(g,{getInitialState:()=>({gridRect:e.getBoundingClientRect(),startLeftPercent:parseFloat(r.style.left),startTopPercent:parseFloat(r.style.top)}),onMove:(m,f)=>{const{gridRect:h,startLeftPercent:p,startTopPercent:v}=f.initialState;if(h.width===0||h.height===0)return;const S=m.clientX-f.startX,B=m.clientY-f.startY;r.style.left=`${p+S/h.width*100}%`,r.style.top=`${v+B/h.height*100}%`},onEnd:()=>{dt({left:parseFloat(r.style.left),top:parseFloat(r.style.top)})}}))};r.addEventListener("mousedown",c),r.addEventListener("touchstart",c)}function mt(t,e,r=null){if(!e)return;const o=x("div","arrow-container"),i=document.createElementNS("http://www.w3.org/2000/svg","svg"),l=document.createElementNS("http://www.w3.org/2000/svg","line"),d=x("div","arrow-handle"),s=x("div","arrow-handle"),a=x("div","rotation-handle"),c=x("div","text-toolbar"),g=b=>{const w=r||e.getBoundingClientRect();if(w.width===0)return;const L=w.width*(b.x1/100),k=w.height*(b.y1/100),y=w.width*(b.x2/100),E=w.height*(b.y2/100),I=Math.min(L,y),T=Math.min(k,E);Object.assign(o.style,{left:`${I}px`,top:`${T}px`,width:`${Math.abs(L-y)}px`,height:`${Math.abs(k-E)}px`,transform:`rotate(${b.rotation||0}deg)`});const M=L-I,W=k-T;l.setAttribute("x1",M),l.setAttribute("y1",W),l.setAttribute("x2",y-I),l.setAttribute("y2",E-T),l.setAttribute("stroke-width",b.strokeWidth),l.setAttribute("stroke",b.color),l.setAttribute("stroke-linecap","butt");const U=i.querySelector("marker polygon");U&&U.setAttribute("fill",b.color),d.style.left=`${M}px`,d.style.top=`${W}px`,s.style.left=`${y-I}px`,s.style.top=`${E-T}px`};o.id=`arrow-container-${t.id}`,n.shared.selectedArrowId===t.id&&o.classList.add("selected");const m=`arrowhead-${t.id}`;i.innerHTML=`<defs>
        <marker
            id="${m}"
            viewBox="0 0 12 12"
            refX="10" refY="6"
            markerWidth="9" markerHeight="9"
            orient="auto">
            <polygon points="2 2, 11 6, 2 10, 2 8, 5 6, 2 4" fill="${t.color}"></polygon>
        </marker>
    </defs>`,l.setAttribute("marker-end",`url(#${m})`),i.appendChild(l),c.style.top="-45px",c.innerHTML=`<input type="number" value="${t.strokeWidth}" data-property="strokeWidth" title="Thickness" min="1" max="50"><input type="color" value="${t.color}" data-property="color" title="Color"><button class="toolbar-delete-btn" title="Delete Arrow">&times;</button>`,o.append(i,d,s,a,c),e.appendChild(o),g(t);const f=(b,w)=>{b.addEventListener("mousedown",L=>V.start(L,w)),b.addEventListener("touchstart",L=>V.start(L,w))},h=b=>b.stopPropagation();c.addEventListener("mousedown",h),c.addEventListener("touchstart",h);const p=b=>{const w={[b.target.dataset.property]:b.target.value};tt(w);const k=lt().arrows.find(y=>y.id===t.id);k&&g(k)};c.addEventListener("input",p),c.addEventListener("change",p);const v=c.querySelector(".toolbar-delete-btn"),S=b=>{b.stopPropagation(),b.preventDefault(),Dt()};v.addEventListener("click",S),v.addEventListener("touchend",S),f(o,{onStart:()=>F(t.id),getInitialState:()=>({initialData:{...t},containerStartLeft:o.offsetLeft,containerStartTop:o.offsetTop}),onMove:(b,w)=>{const L=b.clientX-w.startX,k=b.clientY-w.startY;o.style.left=`${w.initialState.containerStartLeft+L}px`,o.style.top=`${w.initialState.containerStartTop+k}px`},onEnd:()=>{const b=o.getBoundingClientRect(),L=lt().arrows.find(U=>U.id===t.id);if(!L)return;const k=e.getBoundingClientRect(),y=(L.x1<L.x2?L.x1:L.x2)/100*k.width,E=(L.y1<L.y2?L.y1:L.y2)/100*k.height,I=b.left-k.left-y,T=b.top-k.top-E,M=I/k.width*100,W=T/k.height*100;(Math.abs(M)>.01||Math.abs(W)>.01)&&tt({x1:L.x1+M,y1:L.y1+W,x2:L.x2+M,y2:L.y2+W})}});const B=b=>({onStart:()=>F(t.id),getInitialState:()=>({gridRect:e.getBoundingClientRect()}),onMove:(w,L)=>{const{gridRect:k}=L.initialState;if(k.width===0||k.height===0)return;const E={...lt().arrows.find(I=>I.id===t.id)};E[b.x]=(w.clientX-k.left)/k.width*100,E[b.y]=(w.clientY-k.top)/k.height*100,tt(E),g(E)},onEnd:()=>{var w;(w=$())==null||w.render()}});f(d,B({x:"x1",y:"y1"})),f(s,B({x:"x2",y:"y2"})),f(a,{onStart:()=>F(t.id),getInitialState:()=>{const b=o.getBoundingClientRect();return{centerX:b.left+b.width/2,centerY:b.top+b.height/2,initialRotation:t.rotation||0}},onMove:(b,w)=>{const{centerX:L,centerY:k,initialRotation:y}=w.initialState,E=Math.atan2(b.clientY-k,b.clientX-L)*(180/Math.PI),I=Math.atan2(w.startY-k,w.startX-L)*(180/Math.PI);o.style.transform=`rotate(${y+(E-I)}deg)`},onEnd:()=>{const b=o.style.transform,w=b?parseFloat(b.replace(/[^0-9.-]/g,"")):0;tt({rotation:w})}})}function G(t,e){if(!e)return;const r=x("div","shape-container");r.id=`shape-container-${t.id}`,Object.assign(r.style,{left:`${t.left}%`,top:`${t.top}%`,width:`${t.width}%`,height:`${t.height}%`,transform:"translate(-50%, -50%)"});const o=x("div","shape-element");o.style.border=`${t.strokeWidth}px solid ${t.color}`,t.type==="ellipse"&&(o.style.borderRadius="50%");const i=x("div","shape-toolbar");i.innerHTML=`<input type="number" value="${t.strokeWidth}" data-property="strokeWidth" title="线条粗细" min="1" max="50"><input type="color" value="${t.color}" data-property="color" title="线条颜色"><button class="toolbar-delete-btn" title="删除形状">&times;</button>`;const l=["n","ne","e","se","s","sw","w","nw"].map(p=>{const v=x("div",`resize-handle ${p}`);return v.dataset.direction=p,v});r.append(o,i,...l),e.appendChild(r),(n.shared.selectedRectangleId===t.id||n.shared.selectedEllipseId===t.id)&&r.classList.add("selected");const d=t.type==="rectangle"?Y:N,s=t.type==="rectangle"?Fe:We,a=t.type==="rectangle"?zt:Ot,c=(p,v)=>{p.addEventListener("mousedown",S=>V.start(S,v)),p.addEventListener("touchstart",S=>V.start(S,v))},g=p=>p.stopPropagation();i.addEventListener("mousedown",g),i.addEventListener("touchstart",g);const m=p=>{const v=p.target.type==="number"?parseFloat(p.target.value):p.target.value,S={[p.target.dataset.property]:v};s(S),o.style.borderColor=S.color||t.color,o.style.borderWidth=S.strokeWidth?`${S.strokeWidth}px`:`${t.strokeWidth}px`};i.addEventListener("input",m),i.addEventListener("change",m);const f=i.querySelector(".toolbar-delete-btn"),h=p=>{p.stopPropagation(),p.preventDefault(),a()};f.addEventListener("click",h),f.addEventListener("touchend",h),c(o,{onStart:()=>d(t.id),getInitialState:()=>({gridRect:e.getBoundingClientRect(),startLeftPercent:t.left,startTopPercent:t.top}),onMove:(p,v)=>{const{gridRect:S,startLeftPercent:B,startTopPercent:b}=v.initialState;if(S.width===0||S.height===0)return;const w=p.clientX-v.startX,L=p.clientY-v.startY;r.style.left=`${B+w/S.width*100}%`,r.style.top=`${b+L/S.height*100}%`},onEnd:()=>s({left:parseFloat(r.style.left),top:parseFloat(r.style.top)})}),l.forEach(p=>{c(p,{onStart:()=>d(t.id),getInitialState:()=>({gridRect:e.getBoundingClientRect(),startLeft:t.left,startTop:t.top,startWidth:t.width,startHeight:t.height,direction:p.dataset.direction}),onMove:(v,S)=>{const{gridRect:B,direction:b,...w}=S.initialState;if(B.width===0||B.height===0)return;const L=(v.clientX-S.startX)/B.width*100,k=(v.clientY-S.startY)/B.height*100;let y=w.startLeft,E=w.startTop,I=w.startWidth,T=w.startHeight;b.includes("e")&&(I+=L),b.includes("w")&&(I-=L,y+=L),b.includes("s")&&(T+=k),b.includes("n")&&(T-=k,E+=k),I>1&&T>1&&(r.style.left=`${y}%`,r.style.top=`${E}%`,r.style.width=`${I}%`,r.style.height=`${T}%`)},onEnd:()=>s({left:parseFloat(r.style.left),top:parseFloat(r.style.top),width:parseFloat(r.style.width),height:parseFloat(r.style.height)})})})}function Qt(){u.layoutControls.classList.remove("hidden"),u.canvasSettings.classList.remove("hidden"),u.borderControls.classList.remove("hidden"),u.layoutWrapper.classList.remove("hidden"),u.canvasHint.classList.remove("hidden")}function Jt(){u.layoutControls.classList.add("hidden"),u.canvasSettings.classList.add("hidden"),u.layoutWrapper.classList.add("hidden"),u.canvasHint.classList.add("hidden")}function ft(){const t=u.layoutGrid;if(t.innerHTML="",Object.keys(n.layout.imagesData).length>0&&n.shared.watermark.enabled){const c=x("canvas","watermark-preview-canvas");c.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",t.appendChild(c),setTimeout(()=>{c.width=t.offsetWidth,c.height=t.offsetHeight,K(c)},150)}const r=n.layout.layoutDef;if(!r)return;const[o,i]=r.gr;n.layout.rowFractions=Array(o).fill(1),n.layout.colFractions=Array(i).fill(1),t.style.gridTemplateRows=n.layout.rowFractions.map(c=>`${c}fr`).join(" "),t.style.gridTemplateColumns=n.layout.colFractions.map(c=>`${c}fr`).join(" ");const l=r.c||Array.from({length:o*i},()=>({r:1,c:1})),d={...n.layout.imagesData},s={};l.forEach((c,g)=>{const m=`cell-${g}`,f=ee(m);if(f.style.gridRowEnd=`span ${c.r}`,f.style.gridColumnEnd=`span ${c.c}`,c.s&&(f.style.gridRowStart=c.s[0],f.style.gridColumnStart=c.s[1]),t.appendChild(f),d[m]){s[m]=d[m];const h=s[m];q(m,h)}}),n.layout.imagesData=s;const a=u.layoutGrid;n.layout.texts.forEach(c=>pt(c,a)),n.layout.arrows.forEach(c=>mt(c,a)),n.layout.rectangles.forEach(c=>G(c,a)),n.layout.ellipses.forEach(c=>G(c,a)),It(),setTimeout(ht,100)}function nt(t,e=null){var s;const r=Array.from(t).filter(a=>a.type.startsWith("image/"));if(r.length===0){C("未选择有效的图片文件","error");return}const o=(a,c)=>{const g=new FileReader;g.onload=m=>{const f=m.target.result,h=new Image;h.onload=()=>{const p={src:f,position:"50% 50%",scale:1,width:h.naturalWidth,height:h.naturalHeight};n.layout.imagesData[c]=p,q(c,p)},h.src=f},g.readAsDataURL(a)},i=[];e&&i.push(e),Array.from(document.querySelectorAll("#layout-grid .grid-cell")).map(a=>a.id).forEach(a=>{a!==e&&(!n.layout.imagesData[a]||!n.layout.imagesData[a].src)&&i.push(a)});const d=e&&((s=n.layout.imagesData[e])==null?void 0:s.src);if(i.length>0){const a=Math.min(r.length,i.length);C(`正在上传 ${a} 张图片...`,"info");let c=0;for(let g=0;g<a;g++)o(r[g],i[g]),c++;setTimeout(()=>{const g=`成功上传 ${c} 张图片。`+(r.length>c?` 已忽略 ${r.length-c} 张。`:"");C(g,"success"),ft(),R()},500)}else d?(C("画布已满，将替换当前图片。","info"),o(r[0],e)):C("没有空的格子可以放置图片","error")}function Kt(){const t=Object.entries(n.layout.imagesData);if(t.length<2)return;const e=t.map(r=>r[1]);for(let r=e.length-1;r>0;r--){const o=Math.floor(Math.random()*(r+1));[e[r],e[o]]=[e[o],e[r]]}t.forEach(([r],o)=>{n.layout.imagesData[r]=e[o],q(r,e[o])}),C("图片已随机排序","info")}function It(){const{spacing:t,radius:e}=n.shared,r=u.layoutGrid;r.style.gap=`${t}px`,r.querySelectorAll(".grid-cell").forEach(o=>{o.style.borderRadius=`${e}px`})}function Zt(){var b;const e=u.layoutWrapper,r=e.offsetWidth;if(!r)return{element:document.createElement("div"),options:{},cleanup:()=>{}};const o=Math.max(1,1600/r),i=r*o,l=window.getComputedStyle(e),d=parseFloat(l.width)/parseFloat(l.height),s=i/d,a=document.createElement("div");Object.assign(a.style,{position:"absolute",top:"-9999px",left:"-9999px",width:`${i}px`,height:`${s}px`});const c=e.cloneNode(!0),g=c.querySelector("#layout-grid");(b=g.querySelector(".watermark-preview-canvas"))==null||b.remove(),g.querySelectorAll(".text-element-container, .arrow-container, .shape-container").forEach(w=>w.remove()),c.style.boxSizing="border-box",c.style.width=`${i}px`,c.style.height=`${s}px`,c.style.backgroundColor=n.shared.bgColor,c.style.backgroundImage=n.shared.backgroundImage?`url(${n.shared.backgroundImage})`:"none",c.style.backgroundSize="cover",c.style.backgroundPosition="center";const m=n.shared.borderWidths||{top:0,right:0,bottom:0,left:0};if(c.style.paddingTop=`${m.top*o}px`,c.style.paddingRight=`${m.right*o}px`,c.style.paddingBottom=`${m.bottom*o}px`,c.style.paddingLeft=`${m.left*o}px`,g){g.style.boxSizing="border-box";const{spacing:w,radius:L}=n.shared,k=w*o,y=L*o;g.style.gap=`${k}px`,g.style.display="grid",g.style.gridTemplateRows=n.layout.rowFractions.map(I=>`${I}fr`).join(" "),g.style.gridTemplateColumns=n.layout.colFractions.map(I=>`${I}fr`).join(" "),g.querySelectorAll(".grid-cell").forEach(I=>{I.style.borderRadius=`${y}px`})}const f=parseFloat(c.style.paddingLeft)||0,h=parseFloat(c.style.paddingRight)||0,p=parseFloat(c.style.paddingTop)||0,v=parseFloat(c.style.paddingBottom)||0,S={width:i-f-h,height:s-p-v};if(n.layout.texts.forEach(w=>pt({...w,fontSize:w.fontSize*o},g)),n.layout.arrows.forEach(w=>mt({...w,strokeWidth:w.strokeWidth*o},g,S)),n.layout.rectangles.forEach(w=>G({...w,strokeWidth:w.strokeWidth*o},g)),n.layout.ellipses.forEach(w=>G({...w,strokeWidth:w.strokeWidth*o},g)),n.shared.watermark.enabled){const w=x("canvas");w.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",g.appendChild(w),setTimeout(()=>{w.width=g.offsetWidth,w.height=g.offsetHeight,K(w,o)},0)}return a.appendChild(c),document.body.appendChild(a),{element:c,options:{useCORS:!0,backgroundColor:null,scale:2},cleanup:()=>{a.parentNode===document.body?document.body.removeChild(a):console.warn("Cleanup skipped: tempContainer was not a direct child of body.")},scaleFactor:o}}function te(t){var e,r;t!==n.layout.currentLayoutId&&((e=u.layoutContainer.querySelector(".active"))==null||e.classList.remove("active"),(r=u.layoutContainer.querySelector(`[data-layout="${t}"]`))==null||r.classList.add("active"),Et(t),ft(),H())}function Ct(t,e){if(!e)return;const r=n.layout.imagesData[t]?{...n.layout.imagesData[t]}:null,o=n.layout.imagesData[e]?{...n.layout.imagesData[e]}:null;r&&(r.position="50% 50%",r.scale=1),o&&(o.position="50% 50%",o.scale=1),n.layout.imagesData[t]=o,o?q(t,o):(delete n.layout.imagesData[t],at(t)),n.layout.imagesData[e]=r,r?q(e,r):(delete n.layout.imagesData[e],at(e))}function ee(t){const e=x("div","grid-cell");e.id=t;const r=x("input");r.type="file",r.accept="image/*",r.id=`input-${t}`,r.multiple=!0,r.className="hidden-file-input",r.onchange=h=>{h.target.files.length>0&&st(h.target.files,t),h.target.value=null};const o=x("div","upload-icon-container");o.innerHTML=j.upload;const i=x("div","cell-button-container"),l=x("div","cell-icon-btn pan-toggle-btn");l.innerHTML=j.pan,l.title="切换平移/拖拽模式";const d=x("div","cell-icon-btn zoom-in-btn");d.innerHTML=j.zoomIn,d.title="放大";const s=x("div","cell-icon-btn zoom-out-btn");s.innerHTML=j.zoomOut,s.title="缩小";const a=x("div","cell-icon-btn reset-btn");a.innerHTML=j.zoomReset,a.title="还原";const c=x("div","cell-icon-btn replace-btn");c.innerHTML=j.replace,c.title="替换图片";const g=x("div","cell-icon-btn remove-btn");g.innerHTML=j.remove,g.title="删除图片";const m=(h,p)=>{const v=S=>{S.stopPropagation(),S.type==="touchend"&&S.preventDefault(),p()};h.addEventListener("click",v),h.addEventListener("touchend",v)};m(l,()=>Ye(t)),m(d,()=>{O(t),qe()}),m(s,()=>{O(t),He()}),m(a,()=>je(t)),m(c,()=>r.click()),m(g,()=>Oe(t)),i.append(l,c,g,d,s,a),e.append(o,r,i),e.addEventListener("wheel",h=>{var b;if(e.id!==n.layout.activeCellId||!e.classList.contains("has-image"))return;h.preventDefault(),h.stopPropagation();const p=((b=n.layout.imagesData[e.id])==null?void 0:b.scale)||1,v=.1,S=h.deltaY<0?1:-1,B=p+S*v;it(B)},{passive:!1});const f={isPinching:!1,initialDistance:0,initialScale:1};return e.addEventListener("touchstart",h=>{var p;h.touches.length===2&&e.id===n.layout.activeCellId&&(h.preventDefault(),f.isPinching=!0,f.initialDistance=Math.hypot(h.touches[0].pageX-h.touches[1].pageX,h.touches[0].pageY-h.touches[1].pageY),f.initialScale=((p=n.layout.imagesData[e.id])==null?void 0:p.scale)||1)},{passive:!1}),e.addEventListener("touchmove",h=>{if(f.isPinching&&h.touches.length===2){h.preventDefault();const v=Math.hypot(h.touches[0].pageX-h.touches[1].pageX,h.touches[0].pageY-h.touches[1].pageY)/f.initialDistance,S=f.initialScale*v,B=Math.max(1,Math.min(S,5));e.style.backgroundSize=`${B*100}%`}},{passive:!1}),e.addEventListener("touchend",h=>{if(f.isPinching){const p=parseFloat(e.style.backgroundSize)/100;it(p),f.isPinching=!1,f.initialDistance=0,f.initialScale=1}}),e}const re=Object.freeze(Object.defineProperty({__proto__:null,activate:Qt,applySharedStyles:It,deactivate:Jt,getDownloadOptions:Zt,processFiles:nt,render:ft,selectNewLayout:te,shuffle:Kt,swapImages:Ct},Symbol.toStringTag,{value:"Module"}));let ot=!1,_=null,gt=-1;function ne(){u.stitchingControls.classList.remove("hidden"),u.stitchingWrapper.classList.remove("hidden"),document.getElementById("stitching-placeholder").classList.toggle("hidden",n.stitching.images.length>0),ce()}function oe(){u.stitchingControls.classList.add("hidden"),u.stitchingWrapper.classList.add("hidden"),u.stitchingGrid.removeEventListener("mousedown",Bt)}function rt(){const t=u.stitchingWrapper,e=u.stitchingGrid;if(n.stitching.images.length===0)t.classList.add("is-empty"),t.style.width="",t.style.height="";else{t.classList.remove("is-empty");const r=e.offsetWidth,o=e.offsetHeight;t.style.width=`${r}px`,t.style.height=`${o}px`}}function J(){const t=u.stitchingGrid,e=document.getElementById("stitching-placeholder"),r=u.stitchingWrapper;if(t.innerHTML="",n.stitching.images.length>0){e.classList.add("hidden"),r.className="collage-wrapper stitching-wrapper",t.className="collage-grid",t.classList.add(n.stitching.direction),t.style.position="relative",n.stitching.images.length>1&&t.classList.add("is-sortable");const l=[];n.stitching.images.forEach((d,s)=>{const a=x("div","stitched-image-container"),c=x("img"),g=new Promise((h,p)=>{c.onload=h,c.onerror=p});l.push(g),c.src=d,c.dataset.index=s,c.draggable=!1;const m=x("button","delete-stitched-image-btn");m.innerHTML="&times;",m.title="删除图片",m.onclick=h=>{h.stopPropagation(),Le(s)};const f=x("button","add-stitched-image-btn");f.innerHTML="+",f.title="在此后插入图片",f.onclick=h=>{h.stopPropagation();const p=x("input");p.type="file",p.multiple=!0,p.accept="image/*",p.style.display="none",p.onchange=v=>{v.target.files.length>0&&xe(v.target.files,s),v.target.value=null,document.body.removeChild(p)},document.body.appendChild(p),p.click()},a.append(c,m,f),t.appendChild(a)}),Promise.all(l).then(()=>{console.log("All stitched images loaded, updating layout."),rt()}).catch(d=>{console.error("An image failed to load in stitching mode.",d),rt()})}else e.classList.remove("hidden"),t.classList.add("hidden");if(n.stitching.images.length===0&&rt(),n.stitching.images.length>0&&n.shared.watermark.enabled){const l=x("canvas","watermark-preview-canvas");l.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",t.appendChild(l),setTimeout(()=>{t.offsetWidth>0&&(l.width=t.offsetWidth,l.height=t.offsetHeight,K(l))},200)}const o=u.stitchingGrid,i=n.stitching;i.texts.forEach(l=>pt(l,o)),i.arrows.forEach(l=>mt(l,o)),i.rectangles.forEach(l=>G(l,o)),i.ellipses.forEach(l=>G(l,o)),Mt()}function ce(){u.stitchingGrid.addEventListener("mousedown",Bt)}function Bt(t){if(t.target.tagName!=="IMG"||n.stitching.images.length<2||(t.preventDefault(),ot=!0,_=t.target.closest(".stitched-image-container"),!_))return;const e=_.querySelector("img");gt=parseInt(e.dataset.index),_.classList.add("dragging"),document.addEventListener("mousemove",$t),document.addEventListener("mouseup",Tt)}function $t(t){if(!ot)return;u.stitchingGrid.querySelectorAll(".drag-over").forEach(r=>r.classList.remove("drag-over"));const e=t.target.closest(".stitched-image-container");e&&e!==_&&e.classList.add("drag-over")}function Tt(t){if(!ot)return;_.classList.remove("dragging"),u.stitchingGrid.querySelectorAll(".drag-over").forEach(r=>r.classList.remove("drag-over"));const e=t.target.closest(".stitched-image-container");if(e&&e!==_){const r=e.querySelector("img");if(r){const o=parseInt(r.dataset.index);ie(gt,o)}}ot=!1,_=null,gt=-1,document.removeEventListener("mousemove",$t),document.removeEventListener("mouseup",Tt)}function ie(t,e){const[r]=n.stitching.images.splice(t,1);n.stitching.images.splice(e,0,r),J()}function Pt(t){const e=Array.from(t).filter(o=>o.type.startsWith("image/"));if(e.length===0){C("未选择有效的图片文件","error");return}document.getElementById("stitching-placeholder").classList.add("hidden");const r=e.map(o=>new Promise(i=>{const l=new FileReader;l.onload=d=>i(d.target.result),l.readAsDataURL(o)}));Promise.all(r).then(o=>{n.stitching.images=n.stitching.images.concat(o),C(`成功添加 ${o.length} 张图片`,"success"),J(),R()})}function ae(){if(!(n.stitching.images.length<2)){for(let t=n.stitching.images.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[n.stitching.images[t],n.stitching.images[e]]=[n.stitching.images[e],n.stitching.images[t]]}J(),C("图片已随机排序","info")}}function Mt(){const{spacing:t,radius:e}=n.shared,r=u.stitchingGrid;r.style.gap=`${t}px`,r.querySelectorAll("img").forEach(o=>{o.style.borderRadius=`${e}px`}),requestAnimationFrame(()=>{n.stitching.images.length>0&&rt()})}function se(){var c;const t=u.stitchingWrapper,e=u.stitchingGrid,r=e.offsetWidth,o=document.createElement("div"),i=e.cloneNode(!0),l=window.getComputedStyle(t);Object.assign(o.style,{padding:l.padding,backgroundColor:l.backgroundColor,backgroundImage:l.backgroundImage,backgroundSize:l.backgroundSize,backgroundPosition:l.backgroundPosition,boxSizing:"border-box",position:"absolute",top:"-9999px",left:"-9999px"}),o.appendChild(i),document.body.appendChild(o);const d=i.offsetWidth,s=r>0?d/r:1;if(s!==1&&(i.style.gap=`${parseFloat(window.getComputedStyle(e).gap)*s}px`,i.querySelectorAll(".text-element-container, .arrow-container, .shape-container").forEach(m=>{const f=m.querySelector(".text-content");if(f){const v=parseFloat(window.getComputedStyle(f).fontSize);f.style.fontSize=`${v*s}px`}const h=m.querySelector("svg line, svg rect, svg ellipse");if(h){const v=h.getAttribute("stroke-width");v&&h.setAttribute("stroke-width",parseFloat(v)*s)}const p=m.querySelector(".shape-element");if(p){const v=parseFloat(window.getComputedStyle(p).borderWidth);p.style.borderWidth=`${v*s}px`}})),(c=i.querySelector(".watermark-preview-canvas"))==null||c.remove(),n.shared.watermark.enabled){const g=x("canvas");g.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",i.appendChild(g),g.width=i.offsetWidth,g.height=i.offsetHeight,K(g,s)}return{element:o,options:{useCORS:!0,backgroundColor:null,scale:1},cleanup:()=>{o.parentNode===document.body&&document.body.removeChild(o)},scaleFactor:s}}function At(t){t!==n.stitching.direction&&(n.stitching.direction=t,document.querySelector("#stitching-direction-btns .active").classList.remove("active"),document.querySelector(`#stitching-direction-btns [data-direction="${t}"]`).classList.add("active"),J())}const le=Object.freeze(Object.defineProperty({__proto__:null,activate:ne,applySharedStyles:Mt,deactivate:oe,getDownloadOptions:se,processFiles:Pt,render:J,setDirection:At,shuffle:ae},Symbol.toStringTag,{value:"Module"})),Z={layout:re,stitching:le};let Q=null;function $(){return Q}function ut(t){if(!(n.currentMode===t&&Q)){for(const e in Z)if(Z.hasOwnProperty(e)){const r=Z[e];e===t?r.activate():r.deactivate()}n.currentMode=t,Q=Z[t],Nt({currentMode:t}),u.layoutModeBtn.classList.toggle("active",t==="layout"),u.stitchingModeBtn.classList.toggle("active",t==="stitching"),Ft(),R()}}function Ft(){Q&&Q.render()}function de(t){var o;const e=(o=t.clipboardData)==null?void 0:o.items;if(!e)return;const r=[];for(const i of e)if(i.kind==="file"&&i.type.startsWith("image/")){const l=i.getAsFile();l&&r.push(l)}r.length>0&&(t.preventDefault(),st(r))}let ct=0;function ge(t){t.preventDefault(),t.stopPropagation(),ct++;const e=document.getElementById("drag-drop-overlay");e&&e.classList.remove("hidden")}function ue(t){if(t.preventDefault(),t.stopPropagation(),ct--,ct===0){const e=document.getElementById("drag-drop-overlay");e&&e.classList.add("hidden")}}function he(t){t.preventDefault(),t.stopPropagation()}function pe(t){t.preventDefault(),t.stopPropagation();const e=document.getElementById("drag-drop-overlay");e&&e.classList.add("hidden"),ct=0;const r=t.dataTransfer.files;r.length>0&&st(r)}function me(){window.addEventListener("paste",de),window.addEventListener("dragenter",ge,!1),window.addEventListener("dragleave",ue,!1),window.addEventListener("dragover",he,!1),window.addEventListener("drop",pe,!1),console.log("Global event listeners (paste, drag & drop) initialized.")}function P(){return n.currentMode==="layout"?n.layout:n.stitching}function K(t,e=1){const r=n.shared.watermark;if(!r.enabled||!r.text)return;const o=t.getContext("2d"),i=r.text,l=r.fontSize*e;o.font=`bold ${l}px Arial, sans-serif`,o.fillStyle=`rgba(0, 0, 0, ${r.opacity})`,o.textBaseline="middle";const d=r.density;if(["low","medium","high"].includes(d)){o.textAlign="center",o.save();const a=t.width/2,c=t.height/2;o.translate(a,c),o.rotate(r.rotation*Math.PI/180),o.translate(-a,-c);const m={low:4,medium:3,high:2}[d]||3,h=o.measureText(i).width+100*e,p=l*m;for(let v=-t.width;v<t.width*2;v+=h)for(let S=-t.height;S<t.height*2;S+=p)o.fillText(i,v,S);o.restore()}else{const a=20*e;let c,g;switch(d){case"top-left":o.textAlign="left",c=a,g=a;break;case"top-right":o.textAlign="right",c=t.width-a,g=a;break;case"bottom-left":o.textAlign="left",c=a,g=t.height-a;break;case"bottom-right":o.textAlign="right",c=t.width-a,g=t.height-a;break;case"center":o.textAlign="center",c=t.width/2,g=t.height/2;break;default:return}o.fillText(i,c,g)}}function X(t){Object.assign(n.shared.watermark,t),Ft(),H()}function H(){const t=n.currentMode;let e={shared:{spacing:n.shared.spacing,radius:n.shared.radius,bgColor:n.shared.bgColor,backgroundImage:n.shared.backgroundImage,borderWidths:n.shared.borderWidths,downloadQuality:n.shared.downloadQuality,watermark:n.shared.watermark}};t==="layout"?e.layout={currentLayoutId:n.layout.currentLayoutId,aspectRatio:n.layout.aspectRatio}:t==="stitching"&&(e.stitching={direction:n.stitching.direction}),Gt(t,e),console.log(`Config saved for ${t} mode.`)}function fe(){window.confirm("您确定要恢复所有设置到初始状态吗？这将清除所有已保存的个性化配置，且无法撤销。")&&(localStorage.removeItem("collageToolConfig_layout"),localStorage.removeItem("collageToolConfig_stitching"),localStorage.removeItem("collageToolAppState"),C("设置已重置，正在刷新...","info"),setTimeout(()=>{window.location.reload()},1500))}function ye(){var t;(t=$())==null||t.shuffle()}function ve(t){n.shared.downloadQuality=t,H()}function we(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}async function Rt(){O(null),z(null),F(null),Y(null),N(null);const t=$();if(!t||typeof t.getDownloadOptions!="function")return C("当前模式不支持导出","error"),null;u.layoutGrid.querySelectorAll(".gutter").forEach(d=>d.style.display="none"),C("正在生成高清晰度图片...","info");const{element:e,options:r,cleanup:o,scaleFactor:i}=t.getDownloadOptions(),l={...r,backgroundColor:null,logging:!1};try{const d=await new Promise((s,a)=>{setTimeout(()=>{html2canvas(e,l).then(s).catch(a)},50)});return K(d,i),{canvas:d,cleanup:o,scaleFactor:i}}catch(d){if(console.error("截图失败:",d),C("截图失败，请重试","error"),o)try{o()}catch{console.warn("Cleanup failed after error.")}return u.layoutGrid.querySelectorAll(".gutter").forEach(s=>s.style.display="block"),null}}async function be(){const t=we();let e=null;if(t)if(e=window.open("","_blank"),e)e.document.write("<!DOCTYPE html><html><head><title>正在处理...</title><style>body{display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;color:#555;}</style></head><body><h1>正在生成您的作品，请稍候...</h1></body></html>"),e.document.close();else{C("弹窗被拦截，请在浏览器设置中允许本站弹出窗口后重试","error");return}const r=await Rt();if(!r){e&&e.close();return}const{canvas:o,cleanup:i}=r,l=n.shared.downloadQuality;let d="image/jpeg",s=1,a="jpg";switch(l){case"high-jpg":s=.95;break;case"medium-jpg":s=.8;break;case"png":d="image/png",a="png";break}if(t&&e){const g=`
            <!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"><title>保存您的作品</title><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;background-color:#f0f2f5;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;text-align:center;padding:20px;box-sizing:border-box}.container{background-color:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}p{font-size:1.1em;color:#333;margin-bottom:20px;line-height:1.5}img{max-width:100%;height:auto;border-radius:8px;border:1px solid #ddd}.highlight{color:#007aff;font-weight:600}</style></head><body><div class="container"><p>请 <span class="highlight">长按</span> 下方图片, 然后选择 <span class="highlight">“存储图像”</span> 或 <span class="highlight">“添加到‘照片’”</span></p><img src="${o.toDataURL(d,s)}" alt="拼图作品"></div></body></html>
        `;e.document.open(),e.document.write(g),e.document.close()}else o.toBlob(c=>{if(!c)return C("生成图片数据失败","error");const g=URL.createObjectURL(c),m=document.createElement("a");m.href=g,m.download=`ops-coffee-${Date.now()}.${a}`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(g),C("下载已开始！","success")},d,s);if(i)try{i()}catch{console.warn("Cleanup function failed.")}u.layoutGrid.querySelectorAll(".gutter").forEach(c=>c.style.display="block")}function Se(t){var e;n.currentMode!=="layout"||!t||t.classList.contains("active")||((e=u.aspectRatioBtns.querySelector(".active"))==null||e.classList.remove("active"),t.classList.add("active"),n.layout.aspectRatio=t.dataset.ratio,yt(),H(),setTimeout(()=>{var r;return(r=$())==null?void 0:r.render()},100))}function Ee(t){n.currentMode==="stitching"&&At(t),H()}function Le(t){var e;n.currentMode==="stitching"&&(t>-1&&t<n.stitching.images.length&&n.stitching.images.splice(t,1),(e=$())==null||e.render(),R())}function xe(t,e){if(n.currentMode!=="stitching")return;const r=Array.from(t).filter(i=>i.type.startsWith("image/"));if(r.length===0)return;const o=r.map(i=>new Promise(l=>{const d=new FileReader;d.onload=s=>l(s.target.result),d.readAsDataURL(i)}));Promise.all(o).then(i=>{var l;n.stitching.images.splice(e+1,0,...i),C(`成功插入 ${i.length} 张图片`,"success"),(l=$())==null||l.render(),R()})}function st(t,e=null){if(!t||t.length===0)return;const r=Array.from(t).filter(o=>o.type.startsWith("image/"));if(r.length===0){C("未选择有效的图片文件","error");return}if(n.currentMode==="layout"){const o=Object.keys(n.layout.imagesData).length>0,i=r.length;if(!o&&i>0){const l=n.layout.currentLayoutId,d=D[l];if((d?d.g:0)===i){console.log(`数量匹配，使用当前已选布局: ${l}`),nt(r,e);return}else if(i>1){const a=ke(i);if(a){console.log(`自动匹配新布局: ${a}`),Ie(a,r);return}}}nt(r,e)}else n.currentMode==="stitching"&&Pt(r)}function ke(t){const e=Object.entries(D),r=e.filter(([,i])=>i.g===t);if(r.length>0){const i=Math.floor(Math.random()*r.length);return r[i][0]}const o=e.filter(([,i])=>i.g>=t).sort(([,i],[,l])=>i.g-l.g);return o.length>0?o[0][0]:null}function Ie(t,e){var o,i;if(n.currentMode!=="layout"||!D[t])return;(o=u.layoutContainer.querySelector(".active"))==null||o.classList.remove("active");const r=u.layoutContainer.querySelector(`[data-layout="${t}"]`);r&&r.classList.add("active"),n.layout.currentLayoutId=t,n.layout.layoutDef=D[t],n.layout.imagesData={},(i=$())==null||i.render(),setTimeout(()=>{nt(e,null)},150),H()}function Ce(t){var o,i;if(n.currentMode!=="layout"||n.layout.currentLayoutId===t)return;const e=Object.values(n.layout.imagesData).filter(l=>l&&l.src);(o=u.layoutContainer.querySelector(".active"))==null||o.classList.remove("active");const r=u.layoutContainer.querySelector(`[data-layout="${t}"]`);r&&r.classList.add("active"),n.layout.currentLayoutId=t,n.layout.layoutDef=D[t],n.layout.imagesData={},(i=$())==null||i.render(),e.length>0&&setTimeout(()=>{const l=document.querySelectorAll("#layout-grid .grid-cell"),d={},s=Math.min(l.length,e.length);for(let a=0;a<s;a++){const c=l[a].id,g=e[a];d[c]=g,q(c,g)}n.layout.imagesData=d,R()},100),H()}function Be(t){const e=new FileReader;e.onload=r=>{n.shared.backgroundImage=r.target.result,A()},e.readAsDataURL(t),H()}function $e(){n.shared.backgroundImage=null,A()}function Te(){var i;const t=P(),r=window.innerWidth<768?16:24,o={id:Date.now(),content:"文字",color:"#ff0000",fontSize:r,top:30,left:30};t.texts.push(o),(i=$())==null||i.render(),z(o.id)}function z(t){var r;if(n.shared.selectedTextId===t)return;const e=n.shared.selectedTextId;if(n.shared.selectedTextId=t,e&&((r=document.getElementById(`text-container-${e}`))==null||r.classList.remove("selected")),t){const o=document.getElementById(`text-container-${t}`);if(o){o.classList.add("selected");const i=o.querySelector(".text-content");Pe(i)}}}function dt(t){if(!n.shared.selectedTextId)return;const e=P().texts.find(i=>i.id===n.shared.selectedTextId);if(!e)return;Object.assign(e,t);const r=document.getElementById(`text-container-${e.id}`);if(!r)return;const o=r.querySelector(".text-content");o&&(t.content&&(o.innerText=t.content),t.fontSize&&(o.style.fontSize=`${t.fontSize}px`),t.color&&(o.style.color=t.color),t.top&&(o.style.top=`${t.top}%`),t.left&&(o.style.left=`${t.left}%`))}function Wt(){var r;if(!n.shared.selectedTextId)return;const t=P(),e=t.texts.findIndex(o=>o.id===n.shared.selectedTextId);e>-1&&(t.texts.splice(e,1),(r=document.getElementById(`text-container-${n.shared.selectedTextId}`))==null||r.remove(),z(null))}function Pe(t){if(t&&(t.focus(),typeof window.getSelection<"u"&&typeof document.createRange<"u")){const e=document.createRange();e.selectNodeContents(t),e.collapse(!1);const r=window.getSelection();r.removeAllRanges(),r.addRange(e)}}function Me(){var i;const t=P(),e=window.innerWidth<768,r={strokeWidth:e?4:3,x1:e?20:25,y1:25,x2:e?45:35,y2:35},o={id:Date.now(),color:"#ff0000",rotation:0,...r};t.arrows.push(o),(i=$())==null||i.render(),F(o.id)}function F(t){var r,o;if(n.shared.selectedArrowId===t&&t!==null)return;const e=n.shared.selectedArrowId;n.shared.selectedArrowId=t,e&&((r=document.getElementById(`arrow-container-${e}`))==null||r.classList.remove("selected")),t&&((o=document.getElementById(`arrow-container-${t}`))==null||o.classList.add("selected"))}function tt(t){if(!n.shared.selectedArrowId)return;const e=P().arrows.find(r=>r.id===n.shared.selectedArrowId);e&&Object.assign(e,t)}function Dt(){var r;if(!n.shared.selectedArrowId)return;const t=P(),e=t.arrows.findIndex(o=>o.id===n.shared.selectedArrowId);e>-1&&(t.arrows.splice(e,1),(r=$())==null||r.render(),F(null))}function Ae(){var o;const t=P(),e=window.innerWidth<768,r={id:Date.now(),type:"rectangle",color:"#ff0000",strokeWidth:4,left:30,top:30,width:e?20:15,height:e?15:10,rotation:0};t.rectangles.push(r),(o=$())==null||o.render(),Y(r.id)}function Y(t){var r,o;if(n.shared.selectedRectangleId===t)return;z(null),F(null),N(null);const e=n.shared.selectedRectangleId;n.shared.selectedRectangleId=t,e&&((r=document.getElementById(`shape-container-${e}`))==null||r.classList.remove("selected")),t&&((o=document.getElementById(`shape-container-${t}`))==null||o.classList.add("selected"))}function Fe(t){if(!n.shared.selectedRectangleId)return;const e=P().rectangles.find(r=>r.id===n.shared.selectedRectangleId);e&&Object.assign(e,t)}function zt(){var r;if(!n.shared.selectedRectangleId)return;const t=P(),e=t.rectangles.findIndex(o=>o.id===n.shared.selectedRectangleId);e>-1&&(t.rectangles.splice(e,1),(r=$())==null||r.render(),Y(null))}function Re(){var o;const t=P(),e=window.innerWidth<768,r={id:Date.now(),type:"ellipse",color:"#ff0000",strokeWidth:4,left:30,top:30,width:e?20:15,height:e?20:15,rotation:0};t.ellipses.push(r),(o=$())==null||o.render(),N(r.id)}function N(t){var r,o;if(n.shared.selectedEllipseId===t)return;z(null),F(null),Y(null);const e=n.shared.selectedEllipseId;n.shared.selectedEllipseId=t,e&&((r=document.getElementById(`shape-container-${e}`))==null||r.classList.remove("selected")),t&&((o=document.getElementById(`shape-container-${t}`))==null||o.classList.add("selected"))}function We(t){if(!n.shared.selectedEllipseId)return;const e=P().ellipses.find(r=>r.id===n.shared.selectedEllipseId);e&&Object.assign(e,t)}function Ot(){var r;if(!n.shared.selectedEllipseId)return;const t=P(),e=t.ellipses.findIndex(o=>o.id===n.shared.selectedEllipseId);e>-1&&(t.ellipses.splice(e,1),(r=$())==null||r.render(),N(null))}function O(t){if(n.currentMode==="layout"&&n.layout.activeCellId!==t){if(n.layout.activeCellId){const e=document.getElementById(n.layout.activeCellId);e&&e.classList.remove("selected")}if(n.layout.activeCellId=t,t){const e=document.getElementById(t);e&&e.classList.add("selected")}}}function De(t){if(typeof t!="string"||t.trim()==="")return[50,50];const e=t.split(" "),r=parseFloat(e[0]),o=e.length>1?parseFloat(e[1]):r;return[isNaN(r)?50:r,isNaN(o)?50:o]}function ze(t,e){if(n.currentMode!=="layout")return;const{activeCellId:r}=n.layout;if(!r)return;const o=n.layout.imagesData[r];if(!o||!o.src)return;const i=document.getElementById(r);if(!i)return;const[l,d]=De(o.position);let s=l-t,a=d-e;s=Math.max(0,Math.min(100,s)),a=Math.max(0,Math.min(100,a));const c=`${s}% ${a}%`;o.position=c,i.style.backgroundPosition=c}function it(t){if(n.currentMode!=="layout")return;const{activeCellId:e}=n.layout;if(!e)return;const r=n.layout.imagesData[e];if(!r||!r.src)return;const o=Math.max(1,Math.min(t,5));r.scale=o,q(e,r)}function Oe(t){n.currentMode==="layout"&&(delete n.layout.imagesData[t],at(t),O(null),R())}const qt=.2;function qe(){if(n.currentMode!=="layout")return;const{activeCellId:t}=n.layout;if(!t||!n.layout.imagesData[t])return;const r=(n.layout.imagesData[t].scale||1)+qt;it(r)}function He(){if(n.currentMode!=="layout")return;const{activeCellId:t}=n.layout;if(!t||!n.layout.imagesData[t])return;const r=(n.layout.imagesData[t].scale||1)-qt;it(r)}function je(t){if(n.currentMode!=="layout")return;const e=n.layout.imagesData[t];e&&(e.scale=1,e.position="50% 50%",q(t,e))}function _e(){const t=document.querySelector(".grid-cell.is-panning-touch");t&&t.classList.remove("is-panning-touch")}function Ye(t){const e=document.getElementById(t);if(!e)return;const r=document.querySelector(".grid-cell.is-panning-touch");r&&r.id!==t&&r.classList.remove("is-panning-touch"),e.classList.toggle("is-panning-touch"),e.classList.contains("is-panning-touch")?O(t):O(null)}function Ne(){var e;if(!confirm("您确定要清空整个画布吗？所有未保存的更改都将丢失。"))return;const t=P();t.texts=[],t.arrows=[],t.rectangles=[],t.ellipses=[],n.currentMode==="layout"?t.imagesData={}:n.currentMode==="stitching"&&(t.images=[]),O(null),z(null),F(null),Y(null),N(null),(e=$())==null||e.render(),R(),C("画布已清空","info")}async function Xe(){if(!navigator.clipboard||!navigator.clipboard.write){C("您的浏览器不支持或未授权剪贴板写入功能","error");return}const t=await Rt();if(!t)return;const{canvas:e,cleanup:r}=t;try{const o=await new Promise(i=>e.toBlob(i,"image/png"));if(!o){C("无法生成图片数据","error");return}await navigator.clipboard.write([new ClipboardItem({"image/png":o})]),C("已成功复制到剪贴板！","success")}catch(o){console.error("复制到剪贴板失败:",o),C("操作失败，您的浏览器可能阻止了该操作","error")}finally{if(r)try{r()}catch{console.warn("Cleanup function failed.")}u.layoutGrid.querySelectorAll(".gutter").forEach(o=>o.style.display="block")}}let St;function C(t,e="info",r=3e3){const o=document.getElementById("toast");o&&(clearTimeout(St),o.textContent=t,o.className="toast",o.classList.add(e),o.classList.add("show"),St=setTimeout(()=>{o.classList.remove("show")},r))}const et=t=>{const e=parseInt(t.value,10);return isNaN(e)||e<0?0:e};function A(){var g;const t=u.spacingSlider.value,e=u.radiusSlider.value,r=u.colorPicker.value,o=et(u.borderTopInput),i=et(u.borderRightInput),l=et(u.borderBottomInput),d=et(u.borderLeftInput);n.shared.spacing=t,n.shared.radius=e,n.shared.bgColor=r,n.shared.borderWidths={top:o,right:i,bottom:l,left:d},u.spacingValue.textContent=t,u.radiusValue.textContent=e;const s=u.layoutWrapper;n.shared.backgroundImage?(s.style.backgroundImage=`url(${n.shared.backgroundImage})`,s.style.backgroundSize="cover",s.style.backgroundPosition="center"):(s.style.backgroundImage="none",s.style.backgroundColor=n.shared.bgColor),s.style.paddingTop=`${n.shared.borderWidths.top}px`,s.style.paddingRight=`${n.shared.borderWidths.right}px`,s.style.paddingBottom=`${n.shared.borderWidths.bottom}px`,s.style.paddingLeft=`${n.shared.borderWidths.left}px`;const a=u.stitchingWrapper,c=u.stitchingGrid;n.shared.backgroundImage?(a.style.backgroundImage=`url(${n.shared.backgroundImage})`,a.style.backgroundSize="cover",a.style.backgroundPosition="center"):(a.style.backgroundImage="none",a.style.backgroundColor=n.shared.bgColor),a.style.padding="0",c.style.paddingTop=`${n.shared.borderWidths.top}px`,c.style.paddingRight=`${n.shared.borderWidths.right}px`,c.style.paddingBottom=`${n.shared.borderWidths.bottom}px`,c.style.paddingLeft=`${n.shared.borderWidths.left}px`,(g=$())==null||g.applySharedStyles(),n.currentMode==="stitching"&&requestAnimationFrame(()=>{const m=$();m&&typeof m.updateLayout=="function"&&m.updateLayout()}),H()}function q(t,e){const r=document.getElementById(t);if(!r||!e||!e.src)return;r.style.backgroundImage=`url('${e.src}')`,r.style.backgroundPosition=e.position,r.classList.add("has-image");const o=r.querySelector(".upload-icon-container");o&&(o.style.display="none");const i=r.clientWidth,l=r.clientHeight;if(!e.width||!e.height||!i||!l){r.style.backgroundSize="cover";return}const d=i/l,s=e.width/e.height,a=e.scale||1;let c;s>d?c=`auto ${a*100}%`:c=`${a*100}% auto`,r.style.backgroundSize=c}function at(t){const e=document.getElementById(t);if(!e)return;e.style.backgroundImage="none",e.classList.remove("has-image");const r=e.querySelector(".upload-icon-container");r&&(r.style.display="flex")}function R(){let t=0;n.currentMode==="layout"?t=Object.keys(n.layout.imagesData).length:t=n.stitching.images.length,u.shuffleBtn.disabled=t<2}function yt(){const t=document.getElementById("center-content"),e=document.getElementById("layout-wrapper"),r=document.getElementById("aspect-ratio-btns"),o=document.getElementById("canvas-action-toolbar");if(!t||!e||!r||!o){console.error("无法找到布局容器或工具栏元素，计算中止。");return}const i=window.getComputedStyle(t),l=parseFloat(i.paddingLeft)+parseFloat(i.paddingRight),d=parseFloat(i.paddingTop)+parseFloat(i.paddingBottom),s=t.clientWidth-l;let a=t.clientHeight-d;const c=window.getComputedStyle(o),g=o.offsetHeight+parseFloat(c.marginBottom);a-=g;const m=r.querySelector(".active");if(!m)return;const f=m.dataset.ratio.split("/"),h=parseFloat(f[0])/parseFloat(f[1]);let p,v;s/a>h?(v=a,p=v*h):(p=s,v=p/h),e.style.width=`${p}px`,e.style.height=`${v}px`,o.style.width=`${p}px`}const Ge=Object.freeze(Object.defineProperty({__proto__:null,applyCanvasStyles:A,applyImageToCell:q,clearImageFromCell:at,showToast:C,updateCanvasSize:yt,updateShuffleButton:R},Symbol.toStringTag,{value:"Module"}));(function(){const t="img.ops-coffee.cn",e=window.location.hostname;e&&e!==t&&e!=="localhost"&&(window.location.href=`https://${t}`)})();function Ue(){u.layoutContainer.innerHTML="";const t={};for(const e in D){const r=D[e];t[r.g]||(t[r.g]=[]),t[r.g].push({id:e,...r})}Object.keys(t).sort((e,r)=>e-r).forEach(e=>{const r=x("h4","layout-group-title");r.textContent=`${e} 张图片`,u.layoutContainer.appendChild(r);const o=x("div","layout-thumbnail-grid");t[e].forEach(i=>{const l=Ve(i.id,i);i.id===n.layout.currentLayoutId&&l.classList.add("active"),o.appendChild(l)}),u.layoutContainer.appendChild(o)})}function Ve(t,e){const r=x("div","layout-thumbnail");r.dataset.layout=t;const o=x("div","thumbnail-grid");return o.style.gridTemplateColumns=`repeat(${e.gr[1]}, 1fr)`,o.style.gridTemplateRows=`repeat(${e.gr[0]}, 1fr)`,(e.c||Array.from({length:e.gr[0]*e.gr[1]},()=>({r:1,c:1}))).forEach(l=>{const d=x("div","thumbnail-cell");d.style.gridRowEnd=`span ${l.r}`,d.style.gridColumnEnd=`span ${l.c}`,l.s&&(d.style.gridRowStart=l.s[0],d.style.gridColumnStart=l.s[1]),o.appendChild(d)}),r.appendChild(o),r}function Qe(){var w,L,k;u.layoutModeBtn.addEventListener("click",()=>ut("layout")),u.stitchingModeBtn.addEventListener("click",()=>ut("stitching")),u.stitchingUploadBtn.addEventListener("click",()=>u.stitchingUploadInput.click()),u.stitchingUploadInput.addEventListener("change",y=>{st(y.target.files),y.target.value=null}),u.stitchingDirectionBtns.addEventListener("click",y=>{const E=y.target.closest("button");E&&Ee(E.dataset.direction)}),u.layoutContainer.addEventListener("click",y=>{const E=y.target.closest(".layout-thumbnail");E&&(Ce(E.dataset.layout),document.getElementById("left-sidebar").classList.contains("is-open")&&document.getElementById("mobile-overlay").click())}),u.aspectRatioBtns.addEventListener("click",y=>{const E=y.target.closest("button");E&&Se(E)}),u.spacingSlider.addEventListener("input",A),u.radiusSlider.addEventListener("input",A),u.borderTopInput.addEventListener("input",A),u.borderRightInput.addEventListener("input",A),u.borderBottomInput.addEventListener("input",A),u.borderLeftInput.addEventListener("input",A),u.colorPicker.addEventListener("input",A),u.downloadBtn.addEventListener("click",be),(w=document.getElementById("copy-btn"))==null||w.addEventListener("click",Xe);const t=document.getElementById("bg-upload-input");document.getElementById("upload-bg-btn").addEventListener("click",()=>t.click()),t.addEventListener("change",y=>{y.target.files&&y.target.files[0]&&Be(y.target.files[0]),y.target.value=null}),document.getElementById("remove-bg-btn").addEventListener("click",$e),document.getElementById("add-text-btn").addEventListener("click",Te),document.getElementById("add-arrow-btn").addEventListener("click",Me),document.getElementById("add-rectangle-btn").addEventListener("click",Ae),document.getElementById("add-ellipse-btn").addEventListener("click",Re),document.getElementById("shuffle-btn").addEventListener("click",ye),document.getElementById("clear-canvas-btn").addEventListener("click",Ne);let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{n.currentMode==="layout"&&(wt(async()=>{const{updateCanvasSize:y}=await Promise.resolve().then(()=>Ge);return{updateCanvasSize:y}},void 0).then(({updateCanvasSize:y})=>y()),wt(async()=>{const{createGutters:y}=await Promise.resolve().then(()=>Vt);return{createGutters:y}},void 0).then(({createGutters:y})=>y()))},150)});const r=document.getElementById("left-sidebar"),o=document.getElementById("right-sidebar"),i=document.getElementById("mobile-overlay"),l=()=>{r.classList.remove("is-open"),o.classList.remove("is-open"),i.classList.add("hidden"),document.body.classList.remove("sidebar-open")};document.getElementById("toggle-left-sidebar").addEventListener("click",y=>{y.stopPropagation(),r.classList.toggle("is-open")?(o.classList.remove("is-open"),i.classList.remove("hidden"),document.body.classList.add("sidebar-open")):l()}),document.getElementById("toggle-right-sidebar").addEventListener("click",y=>{y.stopPropagation(),o.classList.toggle("is-open")?(r.classList.remove("is-open"),i.classList.remove("hidden"),document.body.classList.add("sidebar-open")):l()}),i.addEventListener("click",l);const d=document.getElementById("app-container");document.getElementById("pc-toggle-left").addEventListener("click",()=>d.classList.toggle("left-sidebar-collapsed")),document.getElementById("pc-toggle-right").addEventListener("click",()=>d.classList.toggle("right-sidebar-collapsed")),document.getElementById("stitching-placeholder").addEventListener("click",()=>u.stitchingUploadInput.click()),Je(),document.addEventListener("click",y=>{const E=y.target,I=E.closest(".grid-cell, .text-element-container, .arrow-container, .shape-container"),T=E.closest("#right-sidebar"),M=E.closest("#canvas-action-toolbar"),W=document.querySelector(".grid-cell.is-panning-touch");W&&(E.closest(".pan-toggle-btn")&&W.contains(E)||_e()),!(I||T||M)&&(O(null),z(null),F(null),Y(null),N(null))}),document.addEventListener("keydown",y=>{const E=y.target;if(!(E.isContentEditable||E.tagName==="INPUT"||E.tagName==="TEXTAREA")){if(y.key==="Delete"||y.key==="Backspace"){y.preventDefault(),n.shared.selectedTextId?Wt():n.shared.selectedArrowId?Dt():n.shared.selectedRectangleId?zt():n.shared.selectedEllipseId&&Ot();return}if(n.currentMode==="layout"&&n.layout.activeCellId){let T=0,M=0;switch(y.key){case"ArrowUp":M=-1.5;break;case"ArrowDown":M=1.5;break;case"ArrowLeft":T=-1.5;break;case"ArrowRight":T=1.5;break;default:return}y.preventDefault(),ze(T,M)}}});const s=document.getElementById("layout-wrapper"),a=document.getElementById("canvas-hint");s&&a&&(s.addEventListener("mouseenter",()=>{n.currentMode==="layout"&&a.classList.add("is-visible")}),s.addEventListener("mouseleave",()=>{a.classList.remove("is-visible")}));const c=document.getElementById("reset-settings-btn");c&&(c.innerHTML=j.reset,c.addEventListener("click",fe));const g=document.getElementById("watermark-enabled"),m=document.getElementById("watermark-text"),f=document.getElementById("watermark-fontSize-slider"),h=document.getElementById("watermark-opacity-slider"),p=document.getElementById("watermark-rotation-slider"),v=document.getElementById("watermark-density-btns"),S=document.getElementById("watermark-fontSize-value"),B=document.getElementById("watermark-opacity-value"),b=document.getElementById("watermark-rotation-value");g.checked=n.shared.watermark.enabled,m.value=n.shared.watermark.text,f.value=n.shared.watermark.fontSize,h.value=n.shared.watermark.opacity,p.value=n.shared.watermark.rotation,S.textContent=n.shared.watermark.fontSize,B.textContent=n.shared.watermark.opacity,b.textContent=n.shared.watermark.rotation,(L=v.querySelector(".active"))==null||L.classList.remove("active"),(k=v.querySelector(`[data-density="${n.shared.watermark.density}"]`))==null||k.classList.add("active"),g.addEventListener("change",y=>X({enabled:y.target.checked})),m.addEventListener("input",y=>X({text:y.target.value})),f.addEventListener("input",y=>{S.textContent=y.target.value,X({fontSize:parseFloat(y.target.value)})}),h.addEventListener("input",y=>{B.textContent=y.target.value,X({opacity:parseFloat(y.target.value)})}),p.addEventListener("input",y=>{b.textContent=y.target.value,X({rotation:parseFloat(y.target.value)})}),v.addEventListener("click",y=>{var I;const E=y.target.closest("button");E&&E.dataset.density&&((I=v.querySelector(".active"))==null||I.classList.remove("active"),E.classList.add("active"),X({density:E.dataset.density}))})}function Je(){const t=document.getElementById("layout-grid");if(!t)return;let e={};const r=()=>{if(e.isPanning&&e.activeCell.classList.remove("is-panning"),e.isDragging){e.startCell.classList.remove("dragging");const s=document.querySelector(".grid-cell.drag-over");s&&s.classList.remove("drag-over")}e={},document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",d),document.removeEventListener("touchmove",l,{passive:!1}),document.removeEventListener("touchend",d)},o=(s,a)=>{if(typeof s!="string")return 50;const c=s.trim();if(c.endsWith("%"))return parseFloat(c);if(c.endsWith("px"))return parseFloat(c)/a*100;switch(c){case"top":case"left":return 0;case"bottom":case"right":return 100;case"center":return 50}return 50},i=s=>{if(s.target.isContentEditable||s.target.closest(".text-element-container, .arrow-container, .shape-container"))return;const a=s.touches?s.touches[0]:s,c=a.target.closest(".grid-cell");c&&(s.type==="touchstart"&&s.preventDefault(),r(),e.isMouseDown=!0,e.startCell=c,e.startX=a.clientX,e.startY=a.clientY,document.addEventListener("mousemove",l),document.addEventListener("mouseup",d),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",d))},l=s=>{var c,g;if(!e.isMouseDown)return;s.type==="touchmove"&&s.preventDefault();const a=s.touches?s.touches[0]:s;if(e.isPanning){const m=e.activeCell.getBoundingClientRect(),f=(a.clientX-e.startX)/m.width*100,h=(a.clientY-e.startY)/m.height*100;let p=e.startBgPercentX-f,v=e.startBgPercentY-h;e.activeCell.style.backgroundPosition=`${p}% ${v}%`;return}if(e.isDragging){const m=(c=document.elementFromPoint(a.clientX,a.clientY))==null?void 0:c.closest(".grid-cell"),f=document.querySelector(".grid-cell.drag-over");m!==f&&(f&&f.classList.remove("drag-over"),m&&m!==e.startCell&&m.classList.add("drag-over"));return}if(!e.hasMoved&&(Math.abs(a.clientX-e.startX)>5||Math.abs(a.clientY-e.startY)>5))if(e.hasMoved=!0,(s.altKey||e.startCell.classList.contains("is-panning-touch"))&&e.startCell.classList.contains("has-image")){e.isPanning=!0,e.activeCell=e.startCell,e.activeCell.classList.add("is-panning");const m=e.activeCell.id,h=(((g=n.layout.imagesData[m])==null?void 0:g.position)||"50% 50%").split(" "),p=e.activeCell.getBoundingClientRect();e.startBgPercentX=o(h[0],p.width),e.startBgPercentY=o(h.length>1?h[1]:h[0],p.height)}else e.startCell.classList.contains("has-image")&&(e.isDragging=!0,e.startCell.classList.add("dragging"))},d=s=>{var c;if(!e.isMouseDown)return;const a=s.changedTouches?s.changedTouches[0]:s;if(e.isPanning){const g=e.activeCell.id;n.layout.imagesData[g]&&(n.layout.imagesData[g].position=e.activeCell.style.backgroundPosition)}else if(e.isDragging){const g=(c=document.elementFromPoint(a.clientX,a.clientY))==null?void 0:c.closest(".grid-cell");g&&g!==e.startCell&&Ct(e.startCell.id,g.id)}else if(!e.hasMoved)if(e.startCell.classList.contains("has-image"))O(e.startCell.id);else{const g=e.startCell.querySelector('input[type="file"]');g&&g.click()}r()};t.addEventListener("mousedown",i),t.addEventListener("touchstart",i,{passive:!1})}function Ke(){var o;const t=document.getElementById("quality-selector");if(!t)return;const e=n.shared.downloadQuality,r=t.querySelector(`[data-quality="${e}"]`);r&&((o=t.querySelector(".active"))==null||o.classList.remove("active"),r.classList.add("active")),t.addEventListener("click",i=>{var d;const l=i.target.closest("button");!l||!l.dataset.quality||((d=t.querySelector(".active"))==null||d.classList.remove("active"),l.classList.add("active"),ve(l.dataset.quality))})}function Ze(){if(navigator.userAgent.toLowerCase().includes("micromessenger")){const r=document.getElementById("wechat-overlay");r&&r.classList.remove("hidden")}}function tr(){const t=navigator.userAgent,e=navigator.platform;(/iPad/.test(t)||e==="MacIntel"&&navigator.maxTouchPoints>1)&&(document.body.classList.add("is-ipad"),console.log("iPad device detected. Applying specific fixes."))}function er(){var a,c,g,m,f;if(u.spacingSlider.value=n.shared.spacing,u.radiusSlider.value=n.shared.radius,u.colorPicker.value=n.shared.bgColor,u.spacingValue&&(u.spacingValue.textContent=n.shared.spacing),u.radiusValue&&(u.radiusValue.textContent=n.shared.radius),n.shared.borderWidths&&(u.borderTopInput.value=n.shared.borderWidths.top,u.borderRightInput.value=n.shared.borderWidths.right,u.borderBottomInput.value=n.shared.borderWidths.bottom,u.borderLeftInput.value=n.shared.borderWidths.left),u.aspectRatioBtns){const h=u.aspectRatioBtns.querySelector(`[data-ratio="${n.layout.aspectRatio}"]`);h&&((a=u.aspectRatioBtns.querySelector(".active"))==null||a.classList.remove("active"),h.classList.add("active"))}const t=document.getElementById("quality-selector");if(t){const h=t.querySelector(`[data-quality="${n.shared.downloadQuality}"]`);h&&((c=t.querySelector(".active"))==null||c.classList.remove("active"),h.classList.add("active"))}if(u.stitchingDirectionBtns){const h=u.stitchingDirectionBtns.querySelector(`[data-direction="${n.stitching.direction}"]`);h&&((g=u.stitchingDirectionBtns.querySelector(".active"))==null||g.classList.remove("active"),h.classList.add("active"))}const e=n.shared.watermark,r=document.getElementById("watermark-enabled"),o=document.getElementById("watermark-text"),i=document.getElementById("watermark-fontSize-slider"),l=document.getElementById("watermark-opacity-slider"),d=document.getElementById("watermark-rotation-slider"),s=document.getElementById("watermark-density-btns");r&&(r.checked=e.enabled),o&&(o.value=e.text),i&&(i.value=e.fontSize),l&&(l.value=e.opacity),d&&(d.value=e.rotation),document.getElementById("watermark-fontSize-value")&&(document.getElementById("watermark-fontSize-value").textContent=e.fontSize),document.getElementById("watermark-opacity-value")&&(document.getElementById("watermark-opacity-value").textContent=e.opacity),document.getElementById("watermark-rotation-value")&&(document.getElementById("watermark-rotation-value").textContent=e.rotation),s&&((m=s.querySelector(".active"))==null||m.classList.remove("active"),(f=s.querySelector(`[data-density="${e.density}"]`))==null||f.classList.add("active"))}function rr(){const t=Xt();t&&t.currentMode&&(n.currentMode=t.currentMode);const e=Ut(n.currentMode);e&&Yt(e,n.currentMode),_t(),Qe(),er(),ut(n.currentMode),A(),yt(),Ue(),R(),Ke();const r=document.getElementById("copy-btn"),o=document.getElementById("download-btn");r&&typeof ClipboardItem>"u"&&(r.style.display="none",o&&(o.style.gridColumn="span 2")),tr(),Ze(),me(),console.log("%c 免费在线拼图工具 %c by ops-coffee.cn ","background: #0052cc; color: #fff; padding: 5px; border-radius: 5px 0 0 5px;","background: #f4f5f7; color: #42526e; padding: 5px; border-radius: 0 5px 5px 0;"),console.log("感谢使用！如果您对这个工具有任何建议，欢迎联系我们。微信公众号搜索：运维咖啡吧")}document.addEventListener("DOMContentLoaded",rr);
